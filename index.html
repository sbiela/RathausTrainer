<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rathaus-Trainer f√ºr Max</title>
    <!-- Socket.io enabled for Node.js server -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .container {
            text-align: center;
            max-width: 800px;
            width: 90%;
        }

        h1 {
            font-size: 3rem;
            margin-bottom: 2rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .game-area {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 2rem;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .timer {
            font-size: 4rem;
            font-weight: bold;
            margin-bottom: 2rem;
            color: #ff6b6b;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .image-container {
            margin: 2rem 0;
            width: 100%;
            height: 600px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }
        
        .rathaus-image {
            max-height: 100%;
            max-width: 100%;
            height: auto;
            width: auto;
            object-fit: contain;
            object-position: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            transition: transform 0.3s ease;
        }
        
        

        .rathaus-image:hover {
            transform: scale(1.02);
        }
        
        /* Start and end images should fill the full height */
        .rathaus-image[src*="start.jpeg"],
        .rathaus-image[src*="ende.gif"] {
            height: 100% !important;
            width: auto !important;
            max-width: 100%;
            object-fit: contain;
            object-position: center;
        }

        .city-name {
            font-size: 2rem;
            font-weight: bold;
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            backdrop-filter: blur(5px);
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .controls {
            margin: 2rem 0;
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            gap: 1rem;
            justify-content: center;
        }

        .btn {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            border: none;
            padding: 12px 20px;
            font-size: 1rem;
            color: white;
            border-radius: 50px;
            cursor: pointer;
            margin: 0 5px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            min-width: 140px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        /* Responsive design for smaller screens */
        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: center;
            }
            
            .btn {
                min-width: 200px;
                margin: 5px 0;
            }
            
            .image-container {
                height: 400px;
            }
            
            .rathaus-image {
                max-height: 100%;
                max-width: 100%;
                height: auto;
                width: auto;
            }
            
        }

        .instructions {
            background: rgba(255, 255, 255, 0.1);
            padding: 1.5rem;
            border-radius: 15px;
            margin: 2rem 0;
            backdrop-filter: blur(5px);
        }

        .instructions h3 {
            margin-bottom: 1rem;
            color: #ffd93d;
        }

        .instructions p {
            margin: 0.5rem 0;
            font-size: 1.1rem;
        }

        .results {
            display: none;
            background: rgba(255, 255, 255, 0.2);
            padding: 2rem;
            border-radius: 15px;
            margin-top: 2rem;
            backdrop-filter: blur(10px);
        }

        .results h2 {
            color: #ffd93d;
            margin-bottom: 1rem;
        }

        .score-input {
            margin: 1.5rem 0;
            padding: 1rem;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
        }

        .score-input h3 {
            color: #ffd93d;
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }

        .input-group {
            margin-bottom: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .input-group label {
            color: white;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .input-group input {
            width: 100px;
            padding: 8px;
            border: none;
            border-radius: 8px;
            text-align: center;
            font-size: 1rem;
            background: rgba(255,255,255,0.9);
            color: #333;
        }

        .score {
            font-size: 3rem;
            font-weight: bold;
            color: #4ecdc4;
            margin: 1rem 0;
        }

        .key-hint {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0,0,0,0.7);
            padding: 10px 15px;
            border-radius: 10px;
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 2rem;
            }
            
            .timer {
                font-size: 3rem;
            }
            
            .btn {
                padding: 12px 20px;
                font-size: 1rem;
                margin: 5px;
            }
        }
        
        /* Extra small screens (phones in portrait) */
        @media (max-width: 480px) {
            .image-container {
                height: 300px;
            }
            
            .rathaus-image {
                max-height: 100%;
                max-width: 100%;
                height: auto;
                width: auto;
            }
            
            
            .timer {
                font-size: 2.5rem;
            }
            
            .btn {
                padding: 10px 16px;
                font-size: 0.9rem;
                min-width: 160px;
            }
        }

        .selection-area {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 2rem;
            margin: 2rem 0;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            text-align: center;
            width: 100%;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            display: block !important;
        }

        .selection-area h3 {
            margin: 0 0 1rem 0;
            font-size: 1.2rem;
            font-weight: 600;
            color: #ffd93d;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .selection-controls {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }

        .selection-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 120px;
        }
        
        .role-selection {
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            border: 2px solid rgba(255, 215, 61, 0.3);
            display: block !important;
        }
        
        .role-selection h4 {
            margin: 0 0 1rem 0;
            color: #ffd93d;
            font-size: 1.1rem;
        }
        
        .role-options {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .role-option {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 0.8rem 1.2rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            min-width: 200px;
        }
        
        .role-option:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 215, 61, 0.5);
        }
        
        .role-option input[type="radio"] {
            margin-right: 0.8rem;
            transform: scale(1.2);
        }
        
        .role-option input[type="radio"]:checked + .role-label {
            color: #ffd93d;
            font-weight: bold;
        }
        
        .role-option:has(input:checked) {
            background: rgba(255, 215, 61, 0.2);
            border-color: #ffd93d;
        }
        
        .role-label {
            font-size: 1rem;
            color: white;
            transition: color 0.3s ease;
        }
        
        .game-settings {
            margin-bottom: 1rem;
        }
        
        .game-settings h4 {
            margin: 0 0 1rem 0;
            color: #ffd93d;
            font-size: 1.1rem;
        }
        
        .regie-controls {
            margin: 1rem 0;
            display: flex;
            gap: 1rem;
            justify-content: center;
        }
        
        .regie-btn {
            min-width: 150px;
            font-size: 1.2rem;
            padding: 15px 25px;
        }
        
        .regie-btn.correct {
            background: linear-gradient(45deg, #4CAF50, #45a049);
        }
        
        .regie-btn.incorrect {
            background: linear-gradient(45deg, #f44336, #d32f2f);
        }
        
        .regie-btn.start {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            font-size: 1.3rem;
            min-width: 200px;
        }
        
        .regie-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }
        
        .candidate-controls {
            margin: 1rem 0;
            display: flex;
            justify-content: center;
        }
        
        .candidate-btn {
            min-width: 200px;
            font-size: 1.1rem;
            padding: 12px 20px;
        }
        
        .candidate-btn.back {
            background: linear-gradient(45deg, #6c757d, #5a6268);
        }
        
        .candidate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        
        .room-connection {
            margin-top: 1.5rem;
            padding: 1rem;
            background: rgba(0, 123, 255, 0.1);
            border-radius: 10px;
            border: 1px solid rgba(0, 123, 255, 0.3);
        }
        
        .room-connection h5 {
            margin: 0 0 1rem 0;
            color: #007bff;
            font-size: 1rem;
        }
        
        .room-connection h6 {
            margin: 0.5rem 0;
            color: #007bff;
            font-size: 0.9rem;
        }
        
        .room-controls {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }
        
        .room-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 150px;
        }
        
        .room-group label {
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: white;
        }
        
        .room-group input {
            padding: 8px 12px;
            border-radius: 8px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1rem;
            text-align: center;
            margin-bottom: 0.5rem;
        }
        
        .room-group input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        
        .room-btn {
            background: linear-gradient(45deg, #007bff, #0056b3);
            min-width: 120px;
            font-size: 0.9rem;
            padding: 8px 16px;
        }
        
        .room-info {
            text-align: center;
            color: #28a745;
            font-weight: bold;
        }
        
        .regie-room-controls {
            text-align: center;
            padding: 1rem;
            background: rgba(0, 123, 255, 0.1);
            border-radius: 10px;
            margin-bottom: 1rem;
        }
        
        .candidate-room-controls {
            text-align: center;
        }
        
        .available-rooms {
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }
        
        .available-rooms h5 {
            margin: 0 0 1rem 0;
            color: #ffd93d;
        }
        
        .room-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .room-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        
        .room-item:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .room-item .room-id {
            font-weight: bold;
            color: #007bff;
        }
        
        .room-item .room-status {
            font-size: 0.8rem;
            color: #28a745;
        }

        .selection-group label {
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: white;
        }

        .selection-group input {
            width: 80px;
            padding: 8px;
            border: none;
            border-radius: 8px;
            text-align: center;
            font-size: 1rem;
            background: rgba(255,255,255,0.9);
            color: #333;
        }

        .selection-group input[type="number"] {
            width: 80px;
            padding: 8px;
            border: none;
            border-radius: 8px;
            text-align: center;
            font-size: 1rem;
            background: rgba(255,255,255,0.9);
            color: #333;
        }

        .selection-info {
            margin-bottom: 1rem;
            font-size: 0.9rem;
            color: white;
        }

        .selection-info p {
            margin: 0;
            background: rgba(255,255,255,0.2);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            display: inline-block;
        }

        .history-area {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 2rem;
            margin: 0.5rem 0 2rem 0;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            text-align: center;
            width: 100%;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }

        .history-area h3 {
            margin: 0 0 1rem 0;
            font-size: 1.2rem;
            font-weight: 600;
            color: #ffd93d;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .history-list {
            margin-bottom: 1rem;
            min-height: 100px;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .history-item {
            background: rgba(255,255,255,0.2);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            color: white;
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .history-item.best {
            background: rgba(255, 215, 0, 0.3);
            font-weight: bold;
        }

        .history-score {
            font-weight: bold;
            min-width: 80px;
        }

        .history-time {
            color: #4CAF50;
            min-width: 40px;
            text-align: center;
        }

        .history-speed {
            color: #FF9800;
            min-width: 50px;
            text-align: center;
        }

        .history-date {
            color: #B0BEC5;
            font-size: 0.8rem;
            min-width: 120px;
            text-align: right;
        }

        @media (max-width: 768px) {
            .selection-controls {
                flex-direction: column;
                align-items: center;
            }
            
            .selection-group {
                min-width: 120px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="game-area">
            <div class="timer" id="timer">Rathaus-Duell</div>
            
            <div class="image-container">
                <img id="rathausImage" class="rathaus-image" src="https://rathaus-trainer.vercel.app/start.jpeg" alt="Klein gegen Gro√ü - Rathaus Trainer">
            </div>
            
            <div class="city-name" id="cityName">
                Viel Erfolg!
            </div>
            
            <div class="controls">
                <button class="btn" id="startBtn">üöÄ Spiel starten</button>
                <button class="btn" id="showCityBtn" disabled style="display: none;">Stadt anzeigen (Enter)</button>
                <button class="btn" id="nextBtn" disabled style="display: none;">N√§chstes Rathaus (Leertaste)</button>
            </div>
            
            <!-- Regie Controls (only visible in Regie mode) -->
            <div class="regie-controls" id="regieControls" style="display: none;">
                <button class="btn regie-btn start" id="regieStartBtn">üöÄ Spiel starten</button>
                <div class="regie-game-controls" id="regieGameControls" style="display: none;">
                    <button class="btn regie-btn correct" id="correctBtn">‚úÖ Richtig</button>
                    <button class="btn regie-btn incorrect" id="incorrectBtn">‚ùå Falsch</button>
                </div>
            </div>
            
            <!-- Candidate Controls (only visible in Candidate mode) -->
            <div class="candidate-controls" id="candidateControls" style="display: none;">
                <!-- No controls needed for candidate mode -->
            </div>
            
            <div class="instructions">
                <h3>üìã Anleitung:</h3>
                <p><strong>Leertaste:</strong> N√§chstes Rathaus anzeigen</p>
                <p><strong>Enter-Taste:</strong> Stadtnamen anzeigen/verstecken</p>
                <p><strong>Ziel:</strong> So viele Rath√§user wie m√∂glich in 90 Sekunden erkennen!</p>
            </div>
        </div>
        
        <div class="results" id="results">
            <h2>üéâ Training beendet!</h2>
            
            <div class="score-input">
                <h3>Ergebnis eingeben:</h3>
                <div class="input-group">
                    <label for="totalShown">Angezeigte Rath√§user:</label>
                    <input type="number" id="totalShown" min="1" max="90" readonly>
                </div>
                <div class="input-group">
                    <label for="wrongInput">Fehler:</label>
                    <input type="number" id="wrongInput" min="0" max="90" placeholder="0">
                </div>
                <button class="btn" id="saveResult">Ergebnis speichern</button>
            </div>
            
            <button class="btn" id="restartBtn">Neues Training</button>
        </div>
    </div>
    


        <div class="selection-area" id="selectionArea">
            <h3>üéØ Rollenauswahl & Einstellungen</h3>
            
            <!-- Role Selection -->
            <div class="role-selection">
                <h4>üì∫ Spielmodus w√§hlen</h4>
                <div class="role-options">
                    <label class="role-option">
                        <input type="radio" name="role" value="singleplayer" id="roleSinglePlayer" checked>
                        <span class="role-label">üéÆ SinglePlayer</span>
                    </label>
                    <label class="role-option">
                        <input type="radio" name="role" value="regie" id="roleRegie">
                        <span class="role-label">üéõÔ∏è Regie</span>
                    </label>
                    <label class="role-option">
                        <input type="radio" name="role" value="candidate" id="roleCandidate">
                        <span class="role-label">üé§ Kandidat</span>
                    </label>
                </div>
                
                <!-- Room Connection (only visible for Regie/Candidate) -->
                <div class="room-connection" id="roomConnection" style="display: none;">
                    <h5>üè† Raum-Verbindung</h5>
                    
                    <!-- Regie Room Controls -->
                    <div class="regie-room-controls" id="regieRoomControls" style="display: none;">
                        <div class="room-info">
                            <p>üì° Dein Raum: <span id="regieRoomId"></span></p>
                            <p>üí° Gib diese ID dem Kandidaten weiter!</p>
                        </div>
                    </div>
                    
                    <!-- Candidate Room Controls -->
                    <div class="candidate-room-controls" id="candidateRoomControls" style="display: none;">
                        <div class="room-input">
                            <input type="text" id="roomId" placeholder="Raum-ID eingeben" maxlength="6" style="text-transform: uppercase;">
                            <button class="btn" onclick="joinRoom()">üîó Beitreten</button>
                        </div>
                        
                        <div class="room-info" id="roomInfo" style="display: none;">
                            <p>üì° Verbunden mit Raum: <span id="currentRoomId"></span></p>
                        </div>
                        
                        <!-- Available Rooms -->
                        <div class="available-rooms" id="availableRooms" style="display: none;">
                            <h6>üìã Verf√ºgbare R√§ume:</h6>
                            <div class="room-list" id="roomList"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Game Settings (only visible for Regie) -->
            <div class="game-settings" id="gameSettings">
                <h4>‚öôÔ∏è Spiel-Einstellungen</h4>
                <div class="selection-controls">
                    <div class="selection-group">
                        <label for="fromNumber">Von Rathaus:</label>
                        <input type="number" id="fromNumber" min="1" max="90" value="1" placeholder="1">
                    </div>
                    <div class="selection-group">
                        <label for="toNumber">Bis Rathaus:</label>
                        <input type="number" id="toNumber" min="1" max="90" value="90" placeholder="90">
                    </div>
                    <div class="selection-group">
                        <label for="gameTime">Spielzeit (Sek.):</label>
                        <input type="number" id="gameTime" min="10" max="600" value="90" placeholder="90">
                    </div>
                    <div class="selection-group">
                        <label for="randomOrder">Zuf√§llige Reihenfolge:</label>
                        <input type="checkbox" id="randomOrder" checked>
                    </div>
                </div>
            </div>
            <div class="selection-info" id="selectionInfo">
                <p>Alle 90 Rath√§user verf√ºgbar</p>
            </div>
            <button class="btn" id="applySelection">Auswahl anwenden</button>
        </div>

    <div class="history-area" id="historyArea">
        <h3>üìä Bestenliste</h3>
        <div class="history-list" id="historyList">
            <p>Noch keine Ergebnisse</p>
        </div>
        <button class="btn" id="clearHistory">Bestenliste l√∂schen</button>
    </div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        // Rathaus-Daten (Beispieldaten; k√∂nnen durch geladene Bilder ersetzt werden)
        const defaultRathausData = [
            { name: "M√ºnchen", image: "https://images.unsplash.com/photo-1564507592333-c60657eea523?w=400&h=300&fit=crop" },
            { name: "Berlin", image: "https://images.unsplash.com/photo-1524231757912-21f4fe3a7200?w=400&h=300&fit=crop" },
            { name: "Hamburg", image: "https://images.unsplash.com/photo-1558618666-fcd25c85cd64?w=400&h=300&fit=crop" },
            { name: "K√∂ln", image: "https://images.unsplash.com/photo-1578662996442-48f60103fc96?w=400&h=300&fit=crop" },
            { name: "Frankfurt", image: "https://images.unsplash.com/photo-1545558014-8692077e9b5c?w=400&h=300&fit=crop" },
            { name: "Stuttgart", image: "https://images.unsplash.com/photo-1582407947304-fd86f028f716?w=400&h=300&fit=crop" },
            { name: "D√ºsseldorf", image: "https://images.unsplash.com/photo-1571019613454-1cb2f99b2d8b?w=400&h=300&fit=crop" },
            { name: "Dortmund", image: "https://images.unsplash.com/photo-1558618047-3c8c76ca7d13?w=400&h=300&fit=crop" },
            { name: "Essen", image: "https://images.unsplash.com/photo-1578662996442-48f60103fc96?w=400&h=300&fit=crop" },
            { name: "Leipzig", image: "https://images.unsplash.com/photo-1524231757912-21f4fe3a7200?w=400&h=300&fit=crop" },
            { name: "Bremen", image: "https://images.unsplash.com/photo-1558618666-fcd25c85cd64?w=400&h=300&fit=crop" },
            { name: "Dresden", image: "https://images.unsplash.com/photo-1571019613454-1cb2f99b2d8b?w=400&h=300&fit=crop" },
            { name: "Hannover", image: "https://images.unsplash.com/photo-1582407947304-fd86f028f716?w=400&h=300&fit=crop" },
            { name: "N√ºrnberg", image: "https://images.unsplash.com/photo-1545558014-8692077e9b5c?w=400&h=300&fit=crop" },
            { name: "Duisburg", image: "https://images.unsplash.com/photo-1558618047-3c8c76ca7d13?w=400&h=300&fit=crop" }
        ];

        // Game State
        let gameActive = false;
        let timeLeft = 90;
        let currentIndex = 0;
        let recognizedCount = 0;
        let cityNameVisible = false;
        let timerInterval;
        let currentRole = 'singleplayer'; // 'candidate', 'regie', or 'singleplayer'
        let socket = null;
        // Removed syncInterval - not needed for static deployment
        let currentRoomId = null;
        let roomData = {};
        let loadedRathausData = [];
        let shuffledData = [];
        let rathausData = []; // Add missing rathausData variable

        // DOM Elements
        const timerEl = document.getElementById('timer');
        const rathausImageEl = document.getElementById('rathausImage');
        const cityNameEl = document.getElementById('cityName');
        const startBtn = document.getElementById('startBtn');
        const showCityBtn = document.getElementById('showCityBtn');
        const nextBtn = document.getElementById('nextBtn');
        const resultsEl = document.getElementById('results');
        const restartBtn = document.getElementById('restartBtn');

        // Shuffle array function
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        function getActiveDataset() {
            // Use selected data if available, otherwise use loaded data, otherwise default data
            if (rathausData && rathausData.length > 0) {
                return rathausData;
            } else if (loadedRathausData.length > 0) {
                return loadedRathausData;
            } else {
                return defaultRathausData;
            }
        }

        // Debug function to show current dataset
        function debugDataset() {
            console.log("Current dataset:", getActiveDataset().length, "items");
            console.log("Loaded data:", loadedRathausData.length, "items");
            console.log("Default data:", defaultRathausData.length, "items");
        }

        // Start game
        function startGame() {
            console.log('startGame called');
            gameActive = true;
            timeLeft = parseInt(document.getElementById('gameTime').value) || 90;
            currentIndex = 0;
            recognizedCount = 0;
            // Don't set cityNameVisible here - let showRathaus handle it based on role
            
            // Debug current dataset
            debugDataset();
            
            // Check if random order is enabled
            const randomOrder = document.getElementById('randomOrder').checked;
            
            // Get active dataset
            let activeData = getActiveDataset();
            console.log("Active dataset:", activeData.length, "items");
            
            if (activeData.length === 0) {
                console.error("No data available for game!");
                console.log("Using default data instead");
                // Use default data if no loaded data
                activeData = defaultRathausData;
            }
            
            // Shuffle rathaus data only if random order is enabled
            if (randomOrder) {
                shuffledData = shuffleArray(activeData);
                console.log("Shuffled data:", shuffledData.length, "items");
            } else {
                shuffledData = activeData;
                console.log("Ordered data:", shuffledData.length, "items");
            }
            
            // Show first rathaus
            console.log("Showing rathaus:", shuffledData[currentIndex]);
            showRathaus(shuffledData[currentIndex]);
            
            // Send start game event to server
            if (socket && currentRoomId) {
                socket.emit('start-game', { 
                    roomId: currentRoomId,
                    gameActive: true,
                    currentIndex: currentIndex,
                    timeLeft: timeLeft,
                    shuffledData: shuffledData
                });
            }
            
            // Update room data
            updateRoomData({
                gameActive: true,
                timeLeft: timeLeft,
                currentIndex: currentIndex,
                currentRathaus: shuffledData[currentIndex],
                recognizedCount: recognizedCount,
                shuffledData: shuffledData
            });
            
            // Start timer
            timerInterval = setInterval(updateTimer, 1000);
            
            // Update UI
            startBtn.disabled = true;
            startBtn.style.display = 'none';
            showCityBtn.disabled = false;
            nextBtn.disabled = false;
            showCityBtn.style.display = 'inline-block';
            nextBtn.style.display = 'inline-block';
            resultsEl.style.display = 'none';
            cityNameEl.textContent = '?';
        }

        // Show rathaus
        function showRathaus(rathaus) {
            rathausImageEl.style.display = 'block';
            rathausImageEl.src = rathaus.image;
            rathausImageEl.alt = `Rathaus von ${rathaus.name}`;
            
            console.log('showRathaus called with role:', currentRole, 'rathaus:', rathaus.name);
            
            // Show city name directly for regie and candidate
            if (currentRole === 'regie' || currentRole === 'candidate') {
                cityNameVisible = true;
                cityNameEl.textContent = rathaus.name;
                console.log('Showing city name for', currentRole, ':', rathaus.name);
            } else {
                // Hide city name for singleplayer (use toggle)
                cityNameVisible = false;
                cityNameEl.textContent = '?';
                console.log('Hiding city name for singleplayer');
            }
            
            // Update room data for Regie/Kandidat modes
            if (currentRole === 'regie' || currentRole === 'candidate') {
                updateRoomData({
                    gameActive: gameActive,
                    currentIndex: currentIndex,
                    currentRathaus: rathaus,
                    recognizedCount: recognizedCount,
                    timeLeft: timeLeft,
                    cityNameVisible: cityNameVisible
                });
            }
        }

        // Update timer
        function updateTimer() {
            timeLeft--;
            timerEl.textContent = timeLeft;
            
            // Update room data
            updateRoomData({
                gameActive: true,
                timeLeft: timeLeft,
                currentIndex: currentIndex,
                currentRathaus: shuffledData[currentIndex],
                recognizedCount: recognizedCount
            });
            
            if (timeLeft <= 0) {
                timerEl.textContent = 'Ende';
                endGame();
            }
        }

        // Show/hide city name
        function toggleCityName() {
            if (!gameActive) return;
            
            cityNameVisible = !cityNameVisible;
            const currentRathaus = shuffledData[currentIndex % shuffledData.length];
            
            if (cityNameVisible) {
                cityNameEl.textContent = getDisplayName(currentRathaus);
                recognizedCount++;
            } else {
                cityNameEl.textContent = '?';
            }
        }

        // Next rathaus
        function nextRathaus() {
            if (!gameActive) return;
            
            currentIndex++;
            showRathaus(shuffledData[currentIndex % shuffledData.length]);
            
            // Send next rathaus event to server
            if (socket && currentRoomId) {
                socket.emit('next-rathaus', { 
                    roomId: currentRoomId,
                    currentIndex: currentIndex,
                    currentRathaus: shuffledData[currentIndex]
                });
            }
            
            // Update room data
            updateRoomData({
                gameActive: true,
                timeLeft: timeLeft,
                currentIndex: currentIndex,
                currentRathaus: shuffledData[currentIndex],
                recognizedCount: recognizedCount
            });
        }

        // End game
        function endGame() {
            gameActive = false;
            clearInterval(timerInterval);
            
            // Calculate total shown Rath√§user
            const totalShown = currentIndex + 1; // +1 because currentIndex is 0-based
            
            // Show end image and results
            rathausImageEl.src = 'https://rathaus-trainer.vercel.app/ende.gif';
            rathausImageEl.alt = 'Training beendet!';
            rathausImageEl.style.display = 'block';
            
            
            resultsEl.style.display = 'block';
            
            // Set total shown Rath√§user
            document.getElementById('totalShown').value = totalShown;
            
            // Update buttons
            startBtn.disabled = false;
            startBtn.style.display = 'inline-block';
            startBtn.textContent = 'Training neu starten';
            showCityBtn.disabled = true;
            showCityBtn.style.display = 'none';
            nextBtn.disabled = true;
            
            // Update room data for Regie/Kandidat modes
            if (currentRole === 'regie' || currentRole === 'candidate') {
                updateRoomData({
                    gameActive: false,
                    currentIndex: currentIndex,
                    recognizedCount: recognizedCount,
                    timeLeft: 0,
                    cityNameVisible: false
                });
            }
            nextBtn.style.display = 'none';
            
            // Reset regie buttons
            if (currentRole === 'regie') {
                document.getElementById('regieStartBtn').disabled = false;
                document.getElementById('correctBtn').disabled = true;
                document.getElementById('incorrectBtn').disabled = true;
            }
            
            // Update room data
            updateRoomData({
                gameActive: false,
                timeLeft: 0,
                currentIndex: currentIndex,
                currentRathaus: null,
                recognizedCount: recognizedCount
            });
            
            // Show applauding giphy in the image area
            rathausImageEl.style.display = 'block';
            rathausImageEl.src = 'https://rathaus-trainer.vercel.app/ende.gif';
            rathausImageEl.alt = 'Applaus!';
            
            
            // Hide city name
            cityNameEl.textContent = 'Training beendet!';
            
            // Show result in history area
            const historyList = document.getElementById('historyList');
            const gameTime = parseInt(document.getElementById('gameTime').value) || 90;
            const secondsPerCorrect = totalShown > 0 ? gameTime / totalShown : 0;
            const resultItem = document.createElement('div');
            resultItem.className = 'history-item best';
            resultItem.innerHTML = `
                <span class="history-score">${totalShown}/${totalShown} (100%)</span>
                <span class="history-time">${gameTime}s</span>
                <span class="history-speed">${secondsPerCorrect}s/R</span>
                <span class="history-date">Jetzt</span>
            `;
            historyList.insertBefore(resultItem, historyList.firstChild);
            
            // Update history display
            updateHistoryDisplay();
        }

        // Restart game
        function restartGame() {
            resultsEl.style.display = 'none';
            rathausImageEl.style.display = 'block';
            timerEl.textContent = 'Rathaus-Duell';
            cityNameEl.textContent = 'Viel Erfolg!';
            
            // Show start image when restarting
            rathausImageEl.style.display = 'block';
            rathausImageEl.src = 'https://rathaus-trainer.vercel.app/start.jpeg';
            rathausImageEl.alt = 'Klein gegen Gro√ü - Rathaus Trainer';
            
            // Reset Regie UI
            const regieStartBtn = document.getElementById('regieStartBtn');
            const regieGameControls = document.getElementById('regieGameControls');
            if (regieStartBtn) {
                regieStartBtn.style.display = 'block';
            }
            if (regieGameControls) {
                regieGameControls.style.display = 'none';
            }
            
            startBtn.disabled = false;
            startBtn.style.display = 'inline-block';
            startBtn.textContent = 'Training starten';
            showCityBtn.disabled = true;
            showCityBtn.style.display = 'none';
            nextBtn.disabled = true;
            nextBtn.style.display = 'none';
        }

        // Label storage in localStorage
        const NAME_STORE_KEY = 'rathausLabelsV1';
        function loadNameMap() {
            try {
                const raw = localStorage.getItem(NAME_STORE_KEY);
                return raw ? JSON.parse(raw) : {};
            } catch (e) { return {}; }
        }
        function saveNameMap(map) {
            localStorage.setItem(NAME_STORE_KEY, JSON.stringify(map));
        }
        let nameMap = loadNameMap();

        function makeFileKey(file) {
            return (file.webkitRelativePath || file.name || '').toString();
        }

        function cleanNameFromFilename(filename) {
            let raw = filename.replace(/\.[^.]+$/, '');
            raw = raw.split('/').pop();
            raw = raw.replace(/[_-]+/g, ' ').replace(/\s+/g, ' ').trim();
            raw = raw.replace(/^\d+\s+/, '');
            raw = raw.replace(/Rathaus\s+Seite\s+\d+/i, '').trim();
            raw = raw.split(' ').map(w => w ? (w.charAt(0).toUpperCase() + w.slice(1)) : w).join(' ');
            return raw || 'Unbenannt';
        }

        function getDisplayName(item) {
            let displayName;
            if (item.sourceKey && nameMap[item.sourceKey]) {
                displayName = nameMap[item.sourceKey];
            } else if (item.baseName && item.baseName !== 'Unbenannt') {
                displayName = item.baseName;
            } else {
                displayName = item.name || 'Unbenannt';
            }
            
            // PDF page number removed as requested
            
            return displayName;
        }


        // Event Listeners
        startBtn.addEventListener('click', startGame);
        showCityBtn.addEventListener('click', toggleCityName);
        nextBtn.addEventListener('click', nextRathaus);
        restartBtn.addEventListener('click', restartGame);

        // Selection functionality
        let selectedRathausData = [];
        
        // History functionality
        let gameHistory = JSON.parse(localStorage.getItem('rathausHistory')) || [];
        
        function updateSelectionInfo() {
            const fromNumber = parseInt(document.getElementById('fromNumber').value) || 1;
            const toNumber = parseInt(document.getElementById('toNumber').value) || 90;
            const gameTime = parseInt(document.getElementById('gameTime').value) || 90;
            const randomOrder = document.getElementById('randomOrder').checked;
            
            const availableCount = Math.max(0, toNumber - fromNumber + 1);
            const orderText = randomOrder ? 'Zuf√§llige Reihenfolge' : 'Aufsteigende Reihenfolge';
            const infoEl = document.getElementById('selectionInfo');
            infoEl.innerHTML = `<p>${availableCount} Rath√§user verf√ºgbar (${fromNumber}-${toNumber}) ‚Ä¢ ${gameTime} Sekunden Spielzeit ‚Ä¢ ${orderText}</p>`;
        }
        
        function applySelection() {
            const fromNumber = parseInt(document.getElementById('fromNumber').value) || 1;
            const toNumber = parseInt(document.getElementById('toNumber').value) || 90;
            
            if (!loadedRathausData || loadedRathausData.length === 0) {
                alert('Bitte warte, bis die Bilder geladen sind!');
                return;
            }
            
            // Validate range
            if (fromNumber > toNumber) {
                alert('"Von" muss kleiner oder gleich "Bis" sein!');
                return;
            }
            
            if (fromNumber < 1 || toNumber > loadedRathausData.length) {
                alert(`Bitte w√§hle zwischen 1 und ${loadedRathausData.length}!`);
                return;
            }
            
            // Get selected range
            const selectedRange = loadedRathausData.slice(fromNumber - 1, toNumber);
            
            // Check if random order is enabled
            const randomOrder = document.getElementById('randomOrder').checked;
            
            // Shuffle the selected range if random order is enabled
            if (randomOrder) {
                selectedRathausData = [...selectedRange].sort(() => Math.random() - 0.5);
            } else {
                selectedRathausData = [...selectedRange];
            }
            
            // Update the main data
            rathausData = selectedRathausData;
            
            // Update UI
            cityNameEl.textContent = `Viel Erfolg!`;
            
            // Update selection info to show confirmation
            const gameTime = parseInt(document.getElementById('gameTime').value) || 90;
            const orderText = randomOrder ? 'Zuf√§llige Reihenfolge' : 'Aufsteigende Reihenfolge';
            const infoEl = document.getElementById('selectionInfo');
            infoEl.innerHTML = `<p>‚úÖ ${selectedRathausData.length} Rath√§user ausgew√§hlt (${fromNumber}-${toNumber}) ‚Ä¢ ${gameTime} Sekunden Spielzeit ‚Ä¢ ${orderText}</p>`;
            
            console.log(`Selected ${selectedRathausData.length} Rath√§user from ${fromNumber} to ${toNumber}`);
        }
        
        function addToHistory(score, total, gameTime) {
            const timestamp = new Date().toLocaleString('de-DE');
            const secondsPerCorrect = score > 0 ? gameTime / score : 0;
            const result = {
                score: score,
                total: total,
                percentage: Math.round((score / total) * 100),
                gameTime: gameTime,
                secondsPerCorrect: secondsPerCorrect,
                timestamp: timestamp
            };
            
            gameHistory.unshift(result);
            if (gameHistory.length > 10) {
                gameHistory = gameHistory.slice(0, 10); // Keep only last 10 results
            }
            
            localStorage.setItem('rathausHistory', JSON.stringify(gameHistory));
            updateHistoryDisplay();
        }
        
        function updateHistoryDisplay() {
            const historyList = document.getElementById('historyList');
            
            if (gameHistory.length === 0) {
                historyList.innerHTML = '<p>Noch keine Ergebnisse</p>';
                return;
            }
            
            // Sort by best result (highest score first, then by percentage, then by speed)
            const sortedHistory = [...gameHistory].sort((a, b) => {
                // First sort by score (correct answers)
                if (b.score !== a.score) return b.score - a.score;
                // Then by percentage
                if (b.percentage !== a.percentage) return b.percentage - a.percentage;
                // Then by speed (faster is better)
                return a.secondsPerCorrect - b.secondsPerCorrect;
            });
            
            const bestScore = Math.max(...gameHistory.map(h => h.score));
            
            historyList.innerHTML = sortedHistory.map((result, index) => {
                const isBest = result.score === bestScore;
                const gameTimeText = result.gameTime ? `${result.gameTime}s` : '';
                const secondsPerCorrectText = result.secondsPerCorrect > 0 ? `${result.secondsPerCorrect.toFixed(2)}s/R` : '';
                return `<div class="history-item ${isBest ? 'best' : ''}">
                    <span class="history-score">${result.score}/${result.total} (${result.percentage}%)</span>
                    <span class="history-time">${gameTimeText}</span>
                    <span class="history-speed">${secondsPerCorrectText}</span>
                    <span class="history-date">${result.timestamp}</span>
                </div>`;
            }).join('');
        }
        
        function clearHistory() {
            gameHistory = [];
            localStorage.removeItem('rathausHistory');
            updateHistoryDisplay();
        }
        
        function saveManualResult() {
            const totalShown = document.getElementById('totalShown');
            const wrongInput = document.getElementById('wrongInput');
            
            const total = parseInt(totalShown.value) || 0;
            const wrong = parseInt(wrongInput.value) || 0;
            const correct = total - wrong;
            
            if (total === 0) {
                alert('Keine Rath√§user angezeigt!');
                return;
            }
            
            if (wrong < 0) {
                alert('Fehler k√∂nnen nicht negativ sein!');
                return;
            }
            
            if (wrong > total) {
                alert('Fehler k√∂nnen nicht mehr als angezeigte Rath√§user sein!');
                return;
            }
            
            // Add to history
            const gameTime = parseInt(document.getElementById('gameTime').value) || 90;
            addToHistory(correct, total, gameTime);
            
            // Clear wrong input
            wrongInput.value = '';
            
            // Show success message
            alert(`Ergebnis gespeichert: ${correct}/${total} (${Math.round((correct/total)*100)}%)`);
        }

        // Auto-load images from export_rathaeuser folder
        async function loadRathausImages() {
            try {
                // Test if the first image exists to verify the folder is accessible
                const testImageUrl = './extracted_images/001_Rathaus_Seite_1.jpg';
                const testResponse = await fetch(testImageUrl);
                if (!testResponse.ok) {
                    console.log('Extracted images not found, using default data');
                    return;
                }
                
                // Get list of original image files (JPG format)
                const imageFiles = [
                    '001_Rathaus_Seite_1.jpg', '002_Rathaus_Seite_2.jpg', '003_Rathaus_Seite_3.jpg',
                    '004_Rathaus_Seite_4.jpg', '005_Rathaus_Seite_5.jpg', '006_Rathaus_Seite_6.jpg',
                    '007_Rathaus_Seite_7.jpg', '008_Rathaus_Seite_8.jpg', '009_Rathaus_Seite_9.jpg',
                    '010_Rathaus_Seite_10.jpg', '011_Rathaus_Seite_11.jpg', '012_Rathaus_Seite_12.jpg',
                    '013_Rathaus_Seite_13.jpg', '014_Rathaus_Seite_14.jpg', '015_Rathaus_Seite_15.jpg',
                    '016_Rathaus_Seite_16.jpg', '017_Rathaus_Seite_17.jpg', '018_Rathaus_Seite_18.jpg',
                    '019_Rathaus_Seite_19.jpg', '020_Rathaus_Seite_20.jpg', '021_Rathaus_Seite_21.jpg',
                    '022_Rathaus_Seite_22.jpg', '023_Rathaus_Seite_23.jpg', '024_Rathaus_Seite_24.jpg',
                    '025_Rathaus_Seite_25.jpg', '026_Rathaus_Seite_26.jpg', '027_Rathaus_Seite_27.jpg',
                    '028_Rathaus_Seite_28.jpg', '029_Rathaus_Seite_29.jpg', '030_Rathaus_Seite_30.jpg',
                    '031_Rathaus_Seite_31.jpg', '032_Rathaus_Seite_32.jpg', '033_Rathaus_Seite_33.jpg',
                    '034_Rathaus_Seite_34.jpg', '035_Rathaus_Seite_35.jpg', '036_Rathaus_Seite_36.jpg',
                    '037_Rathaus_Seite_37.jpg', '038_Rathaus_Seite_38.jpg', '039_Rathaus_Seite_39.jpg',
                    '040_Rathaus_Seite_40.jpg', '041_Rathaus_Seite_41.jpg', '042_Rathaus_Seite_42.jpg',
                    '043_Rathaus_Seite_43.jpg', '044_Rathaus_Seite_44.jpg', '045_Rathaus_Seite_45.jpg',
                    '046_Rathaus_Seite_46.jpg', '047_Rathaus_Seite_47.jpg', '048_Rathaus_Seite_48.jpg',
                    '049_Rathaus_Seite_49.jpg', '050_Rathaus_Seite_50.jpg', '051_Rathaus_Seite_51.jpg',
                    '052_Rathaus_Seite_52.jpg', '053_Rathaus_Seite_53.jpg', '054_Rathaus_Seite_54.jpg',
                    '055_Rathaus_Seite_55.jpg', '056_Rathaus_Seite_56.jpg', '057_Rathaus_Seite_57.jpg',
                    '058_Rathaus_Seite_58.jpg', '059_Rathaus_Seite_59.jpg', '060_Rathaus_Seite_60.jpg',
                    '061_Rathaus_Seite_61.jpg', '062_Rathaus_Seite_62.jpg', '063_Rathaus_Seite_63.jpg',
                    '064_Rathaus_Seite_64.jpg', '065_Rathaus_Seite_65.jpg', '066_Rathaus_Seite_66.jpg',
                    '067_Rathaus_Seite_67.jpg', '068_Rathaus_Seite_68.jpg', '069_Rathaus_Seite_69.jpg',
                    '070_Rathaus_Seite_70.jpg', '071_Rathaus_Seite_71.jpg', '072_Rathaus_Seite_72.jpg',
                    '073_Rathaus_Seite_73.jpg', '074_Rathaus_Seite_74.jpg', '075_Rathaus_Seite_75.jpg',
                    '076_Rathaus_Seite_76.jpg', '077_Rathaus_Seite_77.jpg', '078_Rathaus_Seite_78.jpg',
                    '079_Rathaus_Seite_79.jpg', '080_Rathaus_Seite_80.jpg', '081_Rathaus_Seite_81.jpg',
                    '082_Rathaus_Seite_82.jpg', '083_Rathaus_Seite_83.jpg', '084_Rathaus_Seite_84.jpg',
                    '085_Rathaus_Seite_85.jpg', '086_Rathaus_Seite_86.jpg', '087_Rathaus_Seite_87.jpg',
                    '088_Rathaus_Seite_88.jpg', '089_Rathaus_Seite_89.jpg', '090_Rathaus_Seite_90.jpg'
                ];
                
                // Predefined city names for the 90 Rath√§user (based on the actual PDF order)
                const cityNames = [
                    'M√ºnchen', 'Berlin', 'Hamburg', 'K√∂ln', 'Frankfurt am Main', 'Stuttgart', 'D√ºsseldorf', 'Dortmund', 'Essen', 'Leipzig',
                    'Bremen', 'Dresden', 'Hannover', 'N√ºrnberg', 'Duisburg', 'Bochum', 'Wuppertal', 'Bielefeld', 'Bonn', 'M√ºnster',
                    'Karlsruhe', 'Mannheim', 'Augsburg', 'Wiesbaden', 'Gelsenkirchen', 'M√∂nchengladbach', 'Braunschweig', 'Chemnitz', 'Kiel', 'Aachen',
                    'Halle', 'Magdeburg', 'Freiburg im Breisgau', 'Krefeld', 'L√ºbeck', 'Oberhausen', 'Erfurt', 'Mainz', 'Rostock', 'Kassel',
                    'Hagen', 'Hamm', 'Saarbr√ºcken', 'M√ºlheim an der Ruhr', 'Potsdam', 'Ludwigshafen am Rhein', 'Oldenburg', 'Leverkusen', 'Osnabr√ºck', 'Solingen',
                    'Heidelberg', 'Herne', 'Neuss', 'Darmstadt', 'Paderborn', 'Regensburg', 'Ingolstadt', 'W√ºrzburg', 'F√ºrth', 'Wolfsburg',
                    'Offenbach am Main', 'Ulm', 'Heilbronn', 'Pforzheim', 'G√∂ttingen', 'Bottrop', 'Trier', 'Recklinghausen', 'Reutlingen', 'Bremerhaven',
                    'Koblenz', 'Bergisch Gladbach', 'Jena', 'Remscheid', 'Erlangen', 'Moers', 'Siegen', 'Hildesheim', 'Salzgitter', 'Cottbus',
                    'Wien', 'Graz', 'Linz', 'Salzburg', 'Innsbruck', 'Klagenfurt am W√∂rthersee', 'Villach', 'Wels', 'Sankt P√∂lten', 'Dornbirn',
                    'Z√ºrich', 'Genf', 'Basel', 'Bern', 'Lausanne', 'Winterthur', 'Luzern', 'St. Gallen', 'Lugano', 'Biel'
                ];
                
                // Manual mapping based on the actual PDF content
                const manualCityMapping = {
                    '001_Rathaus_Seite_1.jpg': 'Berlin',
                    '002_Rathaus_Seite_2.jpg': 'Hamburg', 
                    '003_Rathaus_Seite_3.jpg': 'M√ºnchen',
                    '004_Rathaus_Seite_4.jpg': 'K√∂ln',
                    '005_Rathaus_Seite_5.jpg': 'Frankfurt am Main',
                    '006_Rathaus_Seite_6.jpg': 'D√ºsseldorf',
                    '007_Rathaus_Seite_7.jpg': 'Stuttgart',
                    '008_Rathaus_Seite_8.jpg': 'Leipzig',
                    '009_Rathaus_Seite_9.jpg': 'Dortmund',
                    '010_Rathaus_Seite_10.jpg': 'Bremen',
                    '011_Rathaus_Seite_11.jpg': 'Essen',
                    '012_Rathaus_Seite_12.jpg': 'Dresden',
                    '013_Rathaus_Seite_13.jpg': 'Hannover',
                    '014_Rathaus_Seite_14.jpg': 'N√ºrnberg',
                    '015_Rathaus_Seite_15.jpg': 'Duisburg',
                    '016_Rathaus_Seite_16.jpg': 'Bochum',
                    '017_Rathaus_Seite_17.jpg': 'Wuppertal',
                    '018_Rathaus_Seite_18.jpg': 'Bielefeld',
                    '019_Rathaus_Seite_19.jpg': 'Bonn',
                    '020_Rathaus_Seite_20.jpg': 'M√ºnster',
                    '021_Rathaus_Seite_21.jpg': 'Karlsruhe',
                    '022_Rathaus_Seite_22.jpg': 'Mannheim',
                    '023_Rathaus_Seite_23.jpg': 'Augsburg',
                    '024_Rathaus_Seite_24.jpg': 'Wiesbaden',
                    '025_Rathaus_Seite_25.jpg': 'Gelsenkirchen',
                    '026_Rathaus_Seite_26.jpg': 'M√∂nchengladbach',
                    '027_Rathaus_Seite_27.jpg': 'Braunschweig',
                    '028_Rathaus_Seite_28.jpg': 'Chemnitz',
                    '029_Rathaus_Seite_29.jpg': 'Kiel',
                    '030_Rathaus_Seite_30.jpg': 'Aachen',
                    '031_Rathaus_Seite_31.jpg': 'Halle',
                    '032_Rathaus_Seite_32.jpg': 'Magdeburg',
                    '033_Rathaus_Seite_33.jpg': 'Freiburg im Breisgau',
                    '034_Rathaus_Seite_34.jpg': 'Krefeld',
                    '035_Rathaus_Seite_35.jpg': 'L√ºbeck',
                    '036_Rathaus_Seite_36.jpg': 'Oberhausen',
                    '037_Rathaus_Seite_37.jpg': 'Erfurt',
                    '038_Rathaus_Seite_38.jpg': 'Mainz',
                    '039_Rathaus_Seite_39.jpg': 'Rostock',
                    '040_Rathaus_Seite_40.jpg': 'Kassel',
                    '041_Rathaus_Seite_41.jpg': 'Hagen',
                    '042_Rathaus_Seite_42.jpg': 'Saarbr√ºcken',
                    '043_Rathaus_Seite_43.jpg': 'Hamm',
                    '044_Rathaus_Seite_44.jpg': 'M√ºlheim an der Ruhr',
                    '045_Rathaus_Seite_45.jpg': 'Potsdam',
                    '046_Rathaus_Seite_46.jpg': 'Ludwigshafen am Rhein',
                    '047_Rathaus_Seite_47.jpg': 'Oldenburg',
                    '048_Rathaus_Seite_48.jpg': 'Leverkusen',
                    '049_Rathaus_Seite_49.jpg': 'Osnabr√ºck',
                    '050_Rathaus_Seite_50.jpg': 'Solingen',
                    '051_Rathaus_Seite_51.jpg': 'Heidelberg',
                    '052_Rathaus_Seite_52.jpg': 'Herne',
                    '053_Rathaus_Seite_53.jpg': 'Neuss',
                    '054_Rathaus_Seite_54.jpg': 'Darmstadt',
                    '055_Rathaus_Seite_55.jpg': 'Paderborn',
                    '056_Rathaus_Seite_56.jpg': 'Regensburg',
                    '057_Rathaus_Seite_57.jpg': 'Ingolstadt',
                    '058_Rathaus_Seite_58.jpg': 'W√ºrzburg',
                    '059_Rathaus_Seite_59.jpg': 'Wolfsburg',
                    '060_Rathaus_Seite_60.jpg': 'Offenbach am Main',
                    '061_Rathaus_Seite_61.jpg': 'Ulm',
                    '062_Rathaus_Seite_62.jpg': 'Heilbronn',
                    '063_Rathaus_Seite_63.jpg': 'Pforzheim',
                    '064_Rathaus_Seite_64.jpg': 'G√∂ttingen',
                    '065_Rathaus_Seite_65.jpg': 'Bottrop',
                    '066_Rathaus_Seite_66.jpg': 'Trier',
                    '067_Rathaus_Seite_67.jpg': 'Recklinghausen',
                    '068_Rathaus_Seite_68.jpg': 'Reutlingen',
                    '069_Rathaus_Seite_69.jpg': 'Bremerhaven',
                    '070_Rathaus_Seite_70.jpg': 'Koblenz',
                    '071_Rathaus_Seite_71.jpg': 'Bergisch Gladbach',
                    '072_Rathaus_Seite_72.jpg': 'Jena',
                    '073_Rathaus_Seite_73.jpg': 'Remscheid',
                    '074_Rathaus_Seite_74.jpg': 'Erlangen',
                    '075_Rathaus_Seite_75.jpg': 'Moers',
                    '076_Rathaus_Seite_76.jpg': 'Siegen',
                    '077_Rathaus_Seite_77.jpg': 'Hildesheim',
                    '078_Rathaus_Seite_78.jpg': 'Salzgiutter',
                    '079_Rathaus_Seite_79.jpg': 'Wien',
                    '080_Rathaus_Seite_80.jpg': 'Graz',
                    '081_Rathaus_Seite_81.jpg': 'Linz',
                    '082_Rathaus_Seite_82.jpg': 'Salzburg',
                    '083_Rathaus_Seite_83.jpg': 'Innsbruck',
                    '084_Rathaus_Seite_84.jpg': 'Klagenfurt am W√∂rthersee',
                    '085_Rathaus_Seite_85.jpg': 'Z√ºrich',
                    '086_Rathaus_Seite_86.jpg': 'Genf',
                    '087_Rathaus_Seite_87.jpg': 'Basel',
                    '088_Rathaus_Seite_88.jpg': 'Bern',
                    '089_Rathaus_Seite_89.jpg': 'Lausanne',
                    '090_Rathaus_Seite_90.jpg': 'Winterthur'
                };
                
                loadedRathausData = imageFiles.map((filename, index) => {
                    const imageUrl = `https://rathaus-trainer.vercel.app/extracted_images/${filename}`;
                    const sourceKey = filename;
                    const cityName = manualCityMapping[filename] || cityNames[index] || `Rathaus ${index + 1}`;
                    const baseName = cityName;
                    const name = nameMap[sourceKey] || baseName;
                    return { name, baseName, image: imageUrl, sourceKey };
                });
                
                console.log(`Auto-loaded ${loadedRathausData.length} Rathaus images`);
                cityNameEl.textContent = `Viel Erfolg!`;
                // Show start image
                rathausImageEl.style.display = 'block';
                rathausImageEl.src = 'https://rathaus-trainer.vercel.app/start.jpeg';
                rathausImageEl.alt = 'Klein gegen Gro√ü - Rathaus Trainer';
                
                // IMPORTANT: Set the loaded data as the active data
                rathausData = loadedRathausData;
            } catch (error) {
                console.log('Could not auto-load images:', error);
                cityNameEl.textContent = 'Viel Erfolg!';
            }
        }

        // Keyboard controls
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space') {
                e.preventDefault();
                if (gameActive) {
                    nextRathaus();
                }
                // Removed: Space no longer starts the game - only use Start button
            } else if (e.code === 'Enter') {
                e.preventDefault();
                if (gameActive) {
                    toggleCityName();
                }
            } else if (e.code === 'KeyN') {
                e.preventDefault();
                if (gameActive) {
                    promptSetNameForCurrent();
                }
            }
        });

        // Role selection event listeners
        document.getElementById('roleCandidate').addEventListener('change', updateRole);
        document.getElementById('roleRegie').addEventListener('change', updateRole);
        document.getElementById('roleSinglePlayer').addEventListener('change', updateRole);
        
        // Room event listeners
        // Check if joinRoomBtn exists before adding event listener
        const joinRoomBtn = document.getElementById('joinRoomBtn');
        if (joinRoomBtn) {
            joinRoomBtn.addEventListener('click', joinRoom);
        }
        
        // Selection event listeners
        document.getElementById('fromNumber').addEventListener('input', updateSelectionInfo);
        document.getElementById('toNumber').addEventListener('input', updateSelectionInfo);
        document.getElementById('gameTime').addEventListener('input', updateSelectionInfo);
        document.getElementById('randomOrder').addEventListener('change', updateSelectionInfo);
        document.getElementById('applySelection').addEventListener('click', applySelection);
        
        // Regie button event listeners
        const regieStartBtn = document.getElementById('regieStartBtn');
        if (regieStartBtn) {
            regieStartBtn.addEventListener('click', () => {
            if (currentRole === 'regie') {
                startGame();
                // Show game controls and hide start button
                const regieGameControls = document.getElementById('regieGameControls');
                if (regieGameControls) {
                    regieGameControls.style.display = 'block';
                }
                regieStartBtn.style.display = 'none';
            }
            });
        }
        
        document.getElementById('correctBtn').addEventListener('click', () => {
            if (currentRole === 'regie' && gameActive) {
                recognizedCount++;
                nextRathaus();
            }
        });
        
        document.getElementById('incorrectBtn').addEventListener('click', () => {
            if (currentRole === 'regie' && gameActive) {
                nextRathaus();
            }
        });
        
        // Candidate button event listeners - removed since candidateBackBtn was removed
        
        // History event listeners
        document.getElementById('clearHistory').addEventListener('click', clearHistory);
        document.getElementById('saveResult').addEventListener('click', saveManualResult);

        // Room management functions
        function generateRoomForRegie() {
            const roomId = Math.random().toString(36).substring(2, 8).toUpperCase();
            document.getElementById('regieRoomId').textContent = roomId;
            document.getElementById('roomId').value = roomId; // Set the room ID input
            currentRoomId = roomId;
            
            // Join room via Socket.io
            if (socket) {
                socket.emit('join-room', roomId, 'regie');
            }
            
            // Create initial room data
            const initialRoomData = {
                gameActive: false,
                currentIndex: 0,
                timeLeft: 0,
                recognizedCount: 0,
                cityNameVisible: true,
                lastUpdate: Date.now()
            };
            
            // Send initial room data
            updateRoomData(initialRoomData);
            
            console.log('Generated room for Regie:', roomId);
            joinRoom();
            console.log('Generated room ID for regie:', roomId);
        }
        
        function loadAvailableRooms() {
            console.log('Loading available rooms...');
            
            // Check if Socket.io is connected
            if (socket && socket.connected) {
                console.log('Requesting room list from server...');
                socket.emit('get-rooms');
            } else {
                console.log('Socket.io not connected yet, waiting for connection...');
                // Wait for Socket.io connection
                if (socket) {
                    socket.once('connect', () => {
                        console.log('Socket.io connected, requesting room list...');
                        socket.emit('get-rooms');
                    });
                } else {
                    console.log('Socket.io not available, showing fallback message');
                    // Socket.io server not available - show fallback message
                    const roomList = document.getElementById('roomList');
                    const availableRoomsDiv = document.getElementById('availableRooms');
                    
                    if (roomList && availableRoomsDiv) {
                        roomList.innerHTML = '<div class="room-item">Socket.io Server nicht verf√ºgbar<br><small>Regie/Kandidat Modi funktionieren im SinglePlayer-Modus</small></div>';
                        availableRoomsDiv.style.display = 'block';
                    }
                }
            }
        }
        
        function updateRoomList(rooms) {
            const roomList = document.getElementById('roomList');
            const availableRoomsDiv = document.getElementById('availableRooms');
            
            if (rooms && rooms.length > 0) {
                roomList.innerHTML = rooms.map(room => `
                    <div class="room-item" onclick="selectRoom('${room.id}')">
                        <span class="room-id">${room.id}</span>
                        <span class="room-status">${room.active ? 'üü¢ Aktiv' : '‚ö™ Verf√ºgbar'}</span>
                    </div>
                `).join('');
                availableRoomsDiv.style.display = 'block';
            } else {
                roomList.innerHTML = '<div class="room-item">Keine R√§ume verf√ºgbar<br><small>Regie muss zuerst einen Raum erstellen</small></div>';
                availableRoomsDiv.style.display = 'block';
            }
        }
        
        function cleanupOldRooms() {
            const now = Date.now();
            const maxAge = 24 * 60 * 60 * 1000; // 24 hours in milliseconds
            const roomsToDelete = [];
            
            console.log('Cleaning up old rooms...');
            
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('rathausRoom_')) {
                    try {
                        const roomData = JSON.parse(localStorage.getItem(key));
                        const lastUpdate = roomData.lastUpdate || 0;
                        const age = now - lastUpdate;
                        
                        if (age > maxAge) {
                            roomsToDelete.push(key);
                            console.log('Room expired:', key, 'age:', Math.round(age / 1000 / 60), 'minutes');
                        }
                    } catch (e) {
                        // Delete invalid room data
                        roomsToDelete.push(key);
                        console.log('Invalid room data, deleting:', key);
                    }
                }
            }
            
            // Delete expired rooms
            roomsToDelete.forEach(key => {
                localStorage.removeItem(key);
                console.log('Deleted room:', key);
            });
            
            if (roomsToDelete.length > 0) {
                console.log('Cleaned up', roomsToDelete.length, 'old rooms');
            }
        }
        
        function clearAllRooms() {
            const roomsToDelete = [];
            
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('rathausRoom_')) {
                    roomsToDelete.push(key);
                }
            }
            
            roomsToDelete.forEach(key => {
                localStorage.removeItem(key);
                console.log('Deleted room:', key);
            });
            
            console.log('Cleared all rooms:', roomsToDelete.length);
            alert(`Alle ${roomsToDelete.length} R√§ume wurden gel√∂scht!`);
            
            // Refresh available rooms
            loadAvailableRooms();
        }
        
        function selectRoom(roomId) {
            document.getElementById('roomId').value = roomId;
            joinRoom();
        }
        
        // URL-based functions for cross-device communication
        function updateUrlForRegie(roomId) {
            // Create shareable URL for GitHub Pages
            const baseUrl = window.location.origin + window.location.pathname;
            const shareUrl = `${baseUrl}?room=${roomId}&role=candidate`;
            
            const regieRoomId = document.getElementById('regieRoomId');
            regieRoomId.innerHTML = `
                <strong>${roomId}</strong><br>
                <small>üìã Gib diese URL dem Kandidaten weiter:</small><br>
                <input type="text" value="${shareUrl}" readonly style="width: 100%; margin-top: 5px; padding: 5px; font-size: 12px;">
                <button onclick="navigator.clipboard.writeText('${shareUrl}')" style="margin-top: 5px; padding: 5px; background-color: #28a745; color: white; border: none; border-radius: 3px; cursor: pointer;">
                    üìã Kopieren
                </button>
            `;
        }
        
        function getRealIPAddress() {
            return new Promise((resolve, reject) => {
                // Try to get IP from WebRTC
                const pc = new RTCPeerConnection({
                    iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
                });
                
                pc.createDataChannel('');
                pc.createOffer().then(offer => pc.setLocalDescription(offer));
                
                pc.onicecandidate = (ice) => {
                    if (ice && ice.candidate && ice.candidate.candidate) {
                        const candidate = ice.candidate.candidate;
                        const ipMatch = candidate.match(/([0-9]{1,3}(\.[0-9]{1,3}){3})/);
                        if (ipMatch) {
                            pc.close();
                            resolve(ipMatch[1]);
                            return;
                        }
                    }
                };
                
                // Timeout after 3 seconds
                setTimeout(() => {
                    pc.close();
                    reject(new Error('Could not determine IP address'));
                }, 3000);
            });
        }
        
        function getLocalIPAddress() {
            // Simple fallback: try to extract IP from current location
            const hostname = window.location.hostname;
            if (hostname !== 'localhost' && hostname !== '127.0.0.1') {
                return Promise.resolve(hostname);
            }
            
            // If we're on localhost, try to get the real IP
            return getRealIPAddress();
        }
        
        function updateUrlForCandidate(roomId) {
            const url = new URL(window.location);
            url.searchParams.set('room', roomId);
            url.searchParams.set('role', 'candidate');
            window.history.replaceState({}, '', url);
            console.log('Updated URL for candidate:', url.toString());
        }
        
        function getUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            return {
                room: urlParams.get('room'),
                role: urlParams.get('role')
            };
        }
        
        function syncFromUrl() {
            const params = getUrlParams();
            if (params.room && currentRole === 'candidate') {
                console.log('Syncing from URL:', params);
                currentRoomId = params.room;
                document.getElementById('roomId').value = params.room;
                document.getElementById('currentRoomId').textContent = params.room;
                document.getElementById('roomInfo').style.display = 'block';
                
                // Polling removed for static deployment
                
                // Try to sync immediately
                syncFromRoom();
            }
        }
        
        // Cross-device synchronization using a simple approach
        function syncFromRegie() {
            if (!currentRoomId) return;
            
            // For cross-device communication, we'll use a simple approach:
            // The regie updates the URL with game state, and the candidate polls the URL
            
            const url = new URL(window.location);
            const gameState = url.searchParams.get('gameState');
            
            if (gameState) {
                try {
                    const data = JSON.parse(decodeURIComponent(gameState));
                    console.log('Syncing from regie URL:', data);
                    
                    // Update game state
                    if (data.gameActive !== gameActive) {
                        gameActive = data.gameActive;
                        if (gameActive) {
                            startGameFromRoom(data);
                        } else {
                            endGameFromRoom();
                        }
                    }
                    
                    // Update current rathaus
                    if (data.currentRathaus && data.currentIndex !== currentIndex) {
                        currentIndex = data.currentIndex;
                        showRathaus(data.currentRathaus);
                        console.log('Updated rathaus for candidate:', data.currentRathaus.name);
                    }
                    
                    // Update timer
                    if (data.timeLeft !== timeLeft) {
                        timeLeft = data.timeLeft;
                        updateTimer();
                    }
                } catch (e) {
                    console.log('Error parsing game state from URL:', e);
                }
            }
        }
        
        function joinRoom() {
            const roomId = document.getElementById('roomId').value.trim().toUpperCase();
            if (!roomId) {
                // Only show alert for candidates, not for regie
                if (currentRole === 'candidate') {
                    alert('Bitte gib eine Raum-ID ein!');
                }
                return;
            }
            
            currentRoomId = roomId;
            document.getElementById('currentRoomId').textContent = roomId;
            document.getElementById('roomInfo').style.display = 'block';
            
            // Join Socket.io room
            if (socket) {
                socket.emit('join-room', { roomId: roomId, role: currentRole });
            }
            
            // Update URL for cross-device sharing
            if (currentRole === 'candidate') {
                updateUrlForCandidate(roomId);
            }
            
            // Room polling removed for static deployment
            
            // If this is a candidate, try to sync immediately
            if (currentRole === 'candidate') {
                syncFromRoom();
            }
            
            console.log('Joined room:', roomId);
        }
        
        function startRoomPolling() {
            if (currentRoomId) {
                // Polling removed for static deployment
                console.log('Room polling disabled for static deployment');
            }
            
            // Auto-refresh disabled for static deployment
        }
        
        function stopRoomPolling() {
            // Polling removed for static deployment
            console.log('Room polling disabled for static deployment');
        }
        
        function syncFromRoom() {
            if (!currentRoomId) return;
            
            try {
                // For GitHub Pages, we use localStorage as the primary sync method
                const roomData = localStorage.getItem(`rathausRoom_${currentRoomId}`);
                if (roomData) {
                    const data = JSON.parse(roomData);
                    console.log('Syncing from localStorage:', data);
                    
                    // Update game state
                    if (data.gameActive !== gameActive) {
                        gameActive = data.gameActive;
                        if (gameActive) {
                            startGameFromRoom(data);
                        } else {
                            endGameFromRoom();
                        }
                    }
                    
                    // Update current rathaus
                    if (data.currentRathaus && data.currentIndex !== currentIndex) {
                        currentIndex = data.currentIndex;
                        showRathaus(data.currentRathaus);
                        console.log('Updated rathaus for candidate:', data.currentRathaus.name);
                    }
                    
                    // Update timer
                    if (data.timeLeft !== timeLeft) {
                        timeLeft = data.timeLeft;
                        updateTimer();
                    }
                }
            } catch (e) {
                console.log('Room sync error:', e);
            }
        }
        
        // For GitHub Pages, we need to poll the URL for updates without reloading
        function pollUrlForUpdates() {
            if (currentRole === 'candidate' && currentRoomId) {
                // Check if URL has been updated by the regie
                const url = new URL(window.location);
                const gameState = url.searchParams.get('gameState');
                
                if (gameState) {
                    try {
                        const data = JSON.parse(decodeURIComponent(gameState));
                        console.log('Polling URL for updates:', data);
                        
                        // Update game state
                        if (data.gameActive !== gameActive) {
                            gameActive = data.gameActive;
                            if (gameActive) {
                                startGameFromRoom(data);
                            } else {
                                endGameFromRoom();
                            }
                        }
                        
                        // Update current rathaus
                        if (data.currentRathaus && data.currentIndex !== currentIndex) {
                            currentIndex = data.currentIndex;
                            showRathaus(data.currentRathaus);
                            console.log('Updated rathaus for candidate:', data.currentRathaus.name);
                        }
                        
                        // Update timer
                        if (data.timeLeft !== timeLeft) {
                            timeLeft = data.timeLeft;
                            updateTimer();
                        }
                    } catch (e) {
                        console.log('Error parsing game state from URL:', e);
                    }
                }
            }
        }
        
        function updateRoomData(data) {
            // Only update room data if we're in a room (Regie/Kandidat mode)
            if (!currentRoomId) {
                console.log('No room ID - skipping room data update (SinglePlayer mode)');
                return;
            }
            
            try {
                // Add timestamp to data
                const dataWithTimestamp = {
                    ...data,
                    lastUpdate: Date.now()
                };
                
                // Send to server via Socket.io
                if (socket) {
                    socket.emit('update-room', dataWithTimestamp);
                }
                
                console.log('Updated room data:', dataWithTimestamp);
            } catch (e) {
                console.log('Room update error:', e);
            }
        }
        
        function updateUrlWithGameState(data) {
            const url = new URL(window.location);
            url.searchParams.set('gameState', encodeURIComponent(JSON.stringify(data)));
            window.history.replaceState({}, '', url);
            console.log('Updated URL with game state:', url.toString());
            
            // For GitHub Pages, we need to notify the candidate immediately
            // We'll use a combination of localStorage and URL parameters
            // The candidate will poll localStorage every 500ms for updates
        }
        
        function startGameFromRoom(data) {
            gameActive = true;
            timeLeft = data.timeLeft;
            currentIndex = data.currentIndex;
            recognizedCount = data.recognizedCount;
            // Don't set cityNameVisible = false for candidates
            
            console.log('Starting game from room:', data);
            
            // Show rathaus
            if (data.currentRathaus) {
                showRathaus(data.currentRathaus);
            }
            
            // Start timer
            startTimer();
        }
        
        function endGameFromRoom() {
            gameActive = false;
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            
            // Show end message
            const cityNameEl = document.getElementById('cityName');
            cityNameEl.textContent = 'Training beendet!';
        }
        
        // Role management functions
        // Socket.io connection
        // socket already declared above
        
        function connectSocket() {
            if (socket) {
                socket.disconnect();
            }
            
            // Only connect to Socket.io for Regie/Kandidat modes
            if (currentRole === 'regie' || currentRole === 'candidate') {
                // Connect to Socket.io server
                const socketUrl = window.location.hostname === 'localhost' ? 'http://localhost:4000' : 'https://rathaustrainer-production.up.railway.app';
                socket = io(socketUrl, {
                    transports: ['websocket', 'polling'],
                    timeout: 20000,
                    forceNew: true
                });
                console.log('Connecting to Socket.io server:', socketUrl);
            } else {
                console.log('SinglePlayer mode - no Socket.io connection needed');
            }
            
            // Socket.io event listeners
            if (socket) {
                socket.on('connect', () => {
                    console.log('Connected to server');
                    
                    // Create room for Regie if not already created
                    if (currentRole === 'regie' && !currentRoomId) {
                        const roomId = generateRoomId();
                        console.log('Creating room for Regie after connection:', roomId);
                        // Use default data if shuffledData is empty
                        const dataToSend = shuffledData.length > 0 ? shuffledData : defaultRathausData;
                        socket.emit('create-room', { 
                            roomId: roomId, 
                            shuffledData: dataToSend 
                        });
                    }
                });
                
                socket.on('disconnect', () => {
                    console.log('Disconnected from server');
                });
                
                socket.on('connect_error', (error) => {
                    console.error('Socket.io connection error:', error);
                });
                
                socket.on('room-created', (data) => {
                    console.log('Room created:', data);
                    currentRoomId = data.roomId;
                    document.getElementById('roomId').value = data.roomId;
                    
                    // Start the game after room is created
                    if (currentRole === 'regie') {
                        console.log('Starting game after room creation');
                        startGameAfterRoomCreation();
                    }
                });
                
                socket.on('room-joined', (data) => {
                    console.log('Joined room:', data);
                    currentRoomId = data.roomId;
                });
                
                socket.on('game-started', (data) => {
                    console.log('Game started:', data);
                    if (currentRole === 'candidate') {
                        gameActive = data.roomData.gameActive;
                        currentIndex = data.roomData.currentIndex;
                        recognizedCount = data.roomData.recognizedCount;
                        
                        if (data.currentRathaus) {
                            showRathaus(data.currentRathaus);
                        }
                    }
                });
                
                socket.on('rathaus-updated', (data) => {
                    console.log('Rathaus updated:', data);
                    if (currentRole === 'candidate') {
                        currentIndex = data.roomData.currentIndex;
                        if (data.currentRathaus) {
                            showRathaus(data.currentRathaus);
                        }
                    }
                });
                
                socket.on('game-ended', (data) => {
                    console.log('Game ended:', data);
                    if (currentRole === 'candidate') {
                        gameActive = false;
                        showEndImage();
                    }
                });
                
                socket.on('room-list', (rooms) => {
                    console.log('Received room list:', rooms);
                    updateRoomList(rooms);
                });
            }
        }

        function updateRole() {
            console.log('updateRole called');
            const candidateRadio = document.getElementById('roleCandidate');
            const regieRadio = document.getElementById('roleRegie');
            const singlePlayerRadio = document.getElementById('roleSinglePlayer');
            const gameSettings = document.getElementById('gameSettings');
            const selectionArea = document.getElementById('selectionArea');
            
            console.log('Elements found:', {
                candidateRadio: !!candidateRadio,
                regieRadio: !!regieRadio,
                singlePlayerRadio: !!singlePlayerRadio,
                gameSettings: !!gameSettings,
                selectionArea: !!selectionArea
            });
            const regieControls = document.getElementById('regieControls');
            const candidateControls = document.getElementById('candidateControls');
            const cityName = document.getElementById('cityName');
            const roomConnection = document.getElementById('roomConnection');
            const regieRoomControls = document.getElementById('regieRoomControls');
            const candidateRoomControls = document.getElementById('candidateRoomControls');
            
            if (candidateRadio.checked) {
                currentRole = 'candidate';
                gameSettings.style.display = 'none';
                selectionArea.style.display = 'block'; // Keep selection area visible
                regieControls.style.display = 'none';
                candidateControls.style.display = 'flex';
                roomConnection.style.display = 'block';
                connectSocket();
                regieRoomControls.style.display = 'none';
                candidateRoomControls.style.display = 'block';
                // Hide all controls for candidate
                document.querySelector('.controls').style.display = 'none';
                const keyHint = document.querySelector('.key-hint');
                if (keyHint) {
                    keyHint.style.display = 'none';
                }
                // Show city name directly for candidate
                cityName.style.display = 'block';
                // Load available rooms
                loadAvailableRooms();
            // Auto-refresh disabled for static deployment
            } else if (regieRadio.checked) {
                currentRole = 'regie';
                gameSettings.style.display = 'block';
                selectionArea.style.display = 'block';
                regieControls.style.display = 'flex';
                candidateControls.style.display = 'none';
                roomConnection.style.display = 'block';
                connectSocket();
                regieRoomControls.style.display = 'block';
                candidateRoomControls.style.display = 'none';
                // Hide normal controls for regie
                document.querySelector('.controls').style.display = 'none';
                const keyHint = document.querySelector('.key-hint');
                if (keyHint) {
                    keyHint.style.display = 'none';
                }
                
                // Create room immediately for Regie
                if (socket && socket.connected) {
                    const roomId = generateRoomId();
                    console.log('Creating room for Regie:', roomId);
                    // Use default data if shuffledData is empty
                    const dataToSend = shuffledData.length > 0 ? shuffledData : defaultRathausData;
                    console.log('Sending create-room event with data:', { roomId, dataLength: dataToSend.length });
                    socket.emit('create-room', { 
                        roomId: roomId, 
                        shuffledData: dataToSend 
                    });
                } else {
                    console.log('Socket not connected yet, will create room when connected');
                }
                // Show city name directly for regie
                cityName.style.display = 'block';
                // Generate room ID for regie
                generateRoomForRegie();
            } else {
                console.log('Setting role to singleplayer');
                currentRole = 'singleplayer';
                gameSettings.style.display = 'block';
                selectionArea.style.display = 'block';
                regieControls.style.display = 'none';
                candidateControls.style.display = 'none';
                roomConnection.style.display = 'none';
                // Show all controls for singleplayer
                document.querySelector('.controls').style.display = 'flex';
                const keyHint = document.querySelector('.key-hint');
                if (keyHint) {
                    keyHint.style.display = 'block';
                }
                // Hide city name for singleplayer (use toggle)
                cityName.style.display = 'block';
                // Polling disabled for static deployment
            }
        }
        
        // URL Sync functions
        function getUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            return {
                role: urlParams.get('role') || 'regie',
                gameActive: urlParams.get('game') === 'true',
                currentIndex: parseInt(urlParams.get('index')) || 0,
                timeLeft: parseInt(urlParams.get('time')) || 90,
                rathausId: urlParams.get('rathaus') || null
            };
        }
        
        function startUrlPolling() {
            if (currentRole === 'candidate') {
                // URL polling removed for static deployment
                console.log('URL polling disabled for static deployment');
            }
        }
        
        function stopUrlPolling() {
            // URL polling removed for static deployment
            console.log('URL polling disabled for static deployment');
        }
        
        function updateUrlForCandidate() {
            if (currentRole !== 'regie') return;
            
            const params = new URLSearchParams();
            params.set('role', 'candidate');
            params.set('game', gameActive.toString());
            params.set('index', currentIndex.toString());
            params.set('time', timeLeft.toString());
            
            if (shuffledData && shuffledData[currentIndex]) {
                params.set('rathaus', shuffledData[currentIndex].sourceKey || '');
            }
            
            // Update URL without page reload
            const newUrl = `${window.location.pathname}?${params.toString()}`;
            window.history.replaceState({}, '', newUrl);
        }
        
        function syncFromUrl() {
            if (currentRole !== 'candidate') return;
            
            const params = getUrlParams();
            console.log('Syncing from URL:', params);
            
            // Update game state
            if (params.gameActive !== gameActive) {
                gameActive = params.gameActive;
                if (gameActive) {
                    startGameFromUrl(params);
                } else {
                    endGameFromUrl();
                }
            }
            
            // Update current rathaus
            if (params.rathausId && params.currentIndex !== currentIndex) {
                currentIndex = params.currentIndex;
                // Find rathaus by ID in loadedRathausData
                const rathaus = loadedRathausData.find(r => r.sourceKey === params.rathausId);
                if (rathaus) {
                    showRathaus(rathaus);
                } else {
                    console.log('Rathaus not found:', params.rathausId);
                }
            }
            
            // Update timer
            if (params.timeLeft !== timeLeft) {
                timeLeft = params.timeLeft;
                updateTimer();
            }
        }
        
        function startGameFromUrl(params) {
            gameActive = true;
            timeLeft = params.timeLeft;
            currentIndex = params.currentIndex;
            recognizedCount = 0;
            cityNameVisible = false;
            
            console.log('Starting game from URL:', params);
            
            // Find and show rathaus
            if (params.rathausId) {
                const rathaus = loadedRathausData.find(r => r.sourceKey === params.rathausId);
                if (rathaus) {
                    showRathaus(rathaus);
                } else {
                    console.log('Rathaus not found in loadedRathausData:', params.rathausId);
                }
            }
            
            // Start timer
            startTimer();
        }
        
        function endGameFromUrl() {
            gameActive = false;
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            
            // Show end message
            const cityNameEl = document.getElementById('cityName');
            cityNameEl.textContent = 'Training beendet!';
        }
        
        // Initialize
        loadRathausImages();
        updateSelectionInfo();
        updateHistoryDisplay();
        
        // Set default role to SinglePlayer
        document.getElementById('roleSinglePlayer').checked = true;
        console.log('Setting default role to SinglePlayer');
        
        // Force visibility of critical elements
        document.getElementById('selectionArea').style.display = 'block';
        document.getElementById('roomConnection').style.display = 'block';
        document.getElementById('gameSettings').style.display = 'block';
        
        // Force visibility of role selection
        const roleSelection = document.querySelector('.role-selection');
        if (roleSelection) {
            roleSelection.style.display = 'block';
        }
        
        updateRole();
        
        // Always start in SinglePlayer mode for static deployment
        console.log('Starting in SinglePlayer mode');
        // Start the game in SinglePlayer mode
        restartGame();
    </script>
</body>
</html>
<!-- Force Vercel deployment -->
<!-- Force Vercel deployment -->
<!-- Force Vercel deployment -->
<!-- Force Vercel deployment -->
<!-- Force Vercel deployment -->
<!-- Force Vercel deployment -->
<!-- Force Vercel deployment -->
<!-- Force Vercel deployment -->
